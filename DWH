CREATE DATABASE Bronze_Layer

USE Bronze_Layer

CREATE TABLE Orders(
	RowID VARCHAR(255),
	OrderID VARCHAR(255),
	OrderDate VARCHAR(255),
	ShipDate VARCHAR(255),
	ShipMode VARCHAR(255),
	CustomerID VARCHAR(255),
	CustomerName VARCHAR(255),
	Segment VARCHAR(255),
	Country VARCHAR(255),
	City VARCHAR(255),
	State VARCHAR(255),
	PostalCode VARCHAR(255),
	Region VARCHAR(255),
	ProductID VARCHAR(255),
	Category VARCHAR(255),
	Sub_Category VARCHAR(255),
	ProductName VARCHAR(255),
	Sales VARCHAR(255),
	Quantity VARCHAR(255),
	Discount VARCHAR(255),
	Profit VARCHAR(255) );


CREATE TABLE Returns(
Returned VARCHAR(255),
OrderID VARCHAR(255));

CREATE TABLE People(
Person VARCHAR(255),
Region VARCHAR(255));

CREATE TABLE CaricamentiLog(
NomeFile VARCHAR(255),
DataCaricamento DATETIME,
NumeroRigheCaricate INT,
ErroreCaricamento VARCHAR(255))

CREATE OR ALTER PROCEDURE CaricaSampleSuperstore AS
SET XACT_ABORT ON
BEGIN TRY
	TRUNCATE TABLE Orders

	TRUNCATE TABLE Returns

	TRUNCATE TABLE People

	BULK INSERT Orders
	FROM 'C:\Users\ianto\Desktop\SQL Data Model\Sample - Superstore_1.csv'
	WITH (
		FIELDTERMINATOR = ';',
		ROWTERMINATOR = '\n',
		FIRSTROW = 2
	);

	BULK INSERT Returns
	FROM 'C:\Users\ianto\Desktop\SQL Data Model\Sample - Superstore_2.csv'
	WITH (
		FIELDTERMINATOR = ';',
		ROWTERMINATOR = '\n',
		FIRSTROW = 2
	);

	BULK INSERT People
	FROM 'C:\Users\ianto\Desktop\SQL Data Model\Sample - Superstore_3.csv'
	WITH (
		FIELDTERMINATOR = ';',
		ROWTERMINATOR = '\n',
		FIRSTROW = 2
	);

	INSERT INTO CaricamentiLog (NomeFile,DataCaricamento,NumeroRigheCaricate,ErroreCaricamento)
	SELECT 'Sample - Superstore.xls',
		GETDATE(),
		(SELECT COUNT(*) FROM Orders)+(SELECT COUNT(*) FROM Returns)+(SELECT COUNT(*) FROM People),
		NULL
	
END TRY
BEGIN CATCH

	INSERT INTO CaricamentiLog (NomeFile,DataCaricamento,NumeroRigheCaricate,ErroreCaricamento)
	SELECT 'Sample - Superstore.xls',
		GETDATE(),
		NULL,
		ERROR_MESSAGE()

END CATCH
